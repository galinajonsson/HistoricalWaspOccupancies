---
title: "Data Cleaning and Standardisation"
author: "Galina M. Jönsson"
date: "18/12/2019"
output: html_document
---

First of all, I need to load R packages that will be required.
```{r installPackages, eval=TRUE, warning=FALSE, message=FALSE}
## Load sparta package and dependencies
require(devtools)
list.of.packages <- c("minqa", "lme4", "gtools", "gtable", "scales",
                      "assertthat", "magrittr", "tibble", "stringr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
install_github('BiologicalRecordsCentre/sparta')
library(sparta)

# Load BRCmap
download.file("https://sites.google.com/site/kitenetter/files/BRCmap_0.10.3.3.zip?attredirects=0&d=1",
        destfile=paste(getwd(),"/BRCmap_0.10.3.3.zip",sep=""))
untar(paste(getwd(),"/BRCmap_0.10.3.3.zip",sep=""), compressed = "xz")
source(paste(getwd(),"/BRCmap",sep=""))
library(BRCmap)
# Load other required packages
require(dplyr)
require(reshape2)
```

# Data standardisation
## NHM records

###Load and tidy the NHM dataset
We digitised the label information of all Vespula vulgaris, Vespula germania and Vespa crabro specimens held by the Natural History Museum London (NHM) and assigned each specimen a barcode number. The full dataset for specimens from UK and other countries can be found via https://doi.org/10.5519/qd.tdi9zagc, whilst the dataset for UK specimens only can be found in the rawData folder within the data folder. For each specimen, we recorded as many of the following pieces of information as possible: species name, collection location, collection date, any additional notes on labels (e.g. if the specimen was bred), location in the NHM (drawer number), aqusition number, sex, collector and caste. All specimens whose collection date was specified to day-level precision (i.e. not only collection year or month) were georeferenced by assigning point coordinates to all collection locations and estimating associated error radii (for protocol, see Blagoderov et al., 2017, DOI: 10.3897/BDJ.5.e19893). Note that some collection locations were given as OSNG grid cells and that these specimes were not georeferenced. 

Firstly, we load the data, change some data classes, and show its structure.
```{r loadNHM, eval=TRUE, message=FALSE, warning=FALSE, tidy=TRUE}
# Load NHM data 
NHM <- read.csv("../data/rawData/NHMraw.csv", header=T, as.is = TRUE, na.strings=c("","NA")) 

# Change the class of some columns
NHM$species <- as.factor(NHM$species)
NHM$county <- as.factor(NHM$county)
NHM$town <- as.factor(NHM$town)
NHM$flag <- as.factor(NHM$flag)
NHM$date <- as.Date(NHM$date, "%Y-%m-%d")

# Show structure of data
str(NHM)
```


We corrected two alternative spellings/names of counties, removed records that only specified county (i.e. no town) and removed all specimen records outside of England
```{r NHMclean-location ,eval=TRUE, message=FALSE, warning=FALSE}
# Rename misspelled county entries: 
NHM$county[NHM$county == "Herefordshire"] <- "West Midlands"
NHM$county[NHM$county == "Oxon"] <- "Oxon."
NHM$county <- droplevels(NHM$county)

# Remove specimens without a specified town
NHM <- NHM[!is.na(NHM$town),]

# Remove specimens collected in Outside of England
NHM <- droplevels(subset(NHM, county != "Ascension Island"))
NHM <- droplevels(subset(NHM, county != "St. Helena"))
NHM <- droplevels(subset(NHM, county != "Scotland"))
NHM <- droplevels(subset(NHM, county != "Channel Islands"))
NHM <- droplevels(subset(NHM, county != "Wales"))

NHM <- droplevels(NHM)
```

The iCollections’ collection site coordinates are given in decimal degrees and the NHM's georefrencing guidelines also requires coordinates to be recorded in decimal degrees, whilst we use OSNG grid references in analyses. Therefore, we covert the decimal degrees into OSNG grid references using the package "BRCmap". We also used a dataset indicating in which country all UK 10x10 OS grid cells are located. This dataset can be found in the auxiliaryData folder within the data folder. 
```{r NHMclean-gridref ,eval=TRUE, message=FALSE, warning=FALSE}
# Use the function "gps_latlon2gr" to convert decimal degrees to gridreferences at a 1x1 m^2 square precision and call the dataframe "OSNG"
NHM$OSNG <- gps_latlon2gr(NHM$latitude_decimal, NHM$longitude_decimal, out_projection = "OSGB", return_type = "both")

# Reformat the 1x1 m^2 grid references to 1 km^2, 2 km^2, 5 km^2, 10 km^2 precision using BRCmap function reformat_gr
NHM$km1grid <- BRCmap::reformat_gr(NHM$OSNG$GRIDREF, prec_out = 1000, precision = NULL, pad_gr = FALSE)

# A few specimens have collection site entered as OSNG grid references, enter these to the km1grid column
for (i in 1:nrow(NHM)){
  if (is.na(NHM[i,6])==FALSE){
    NHM[i,15] <- as.character(NHM[i,6])}
  }

# Continue reformatting all to 2 km^2, 5 km^2, 10 km^2 precision
NHM$km2grid <- BRCmap::reformat_gr(NHM$km1grid, prec_out = 2000, precision = NULL, pad_gr = FALSE)
NHM$km5grid <- BRCmap::reformat_gr(NHM$km1grid, prec_out = 5000, precision = NULL, pad_gr = FALSE)
NHM$km10grid <- BRCmap::reformat_gr(NHM$km1grid, prec_out = 10000, precision = NULL, pad_gr = FALSE)


# Make these columns factors
NHM$km1grid <- as.factor(NHM$km1grid)
NHM$km2grid <- as.factor(NHM$km2grid)
NHM$km5grid <- as.factor(NHM$km5grid)
NHM$km10grid <- as.factor(NHM$km10grid)


# Remove records that don't have 1x1 km precision
NHM <- NHM[!is.na(NHM$km1grid),]

# Again, check that records are from England
# Load csv file specifying which country each 10x10 grid cell is in
country_ID <- read.csv('../data/auxiliaryData/SQ_10km_CN_ID.csv', header=TRUE) 

# As country names are coded from 1 to 7, rename with informative names
cn_names <- data.frame(CN_ID = 1:7,
                       CN_NAME = c('ENGLAND','WALES','SCOTLAND','CHANNEL ISLES',
                                   'NORTHERN IRELAND','REPUBLIC OF IRELAND','ISLE OF MAN'))
country_ID <- merge(x = country_ID, y = cn_names, all.x = TRUE, all.y = FALSE)

# Rename 10x10 grid cell column
colnames(country_ID)[2] <- "km10grid"

# Merge country names with NHM data indicating which country each record is from
NHM <- merge(NHM, country_ID[, c("km10grid", "CN_NAME")], by="km10grid")

# Can now remove the OSNG data frame
NHM <- NHM[ , !(names(NHM) %in% c("OSNG"))]

# Get rid of records with a location error radius greater than 10 km, but first change all NA error radii (these are all from specimens with locations given as grid cells at 1x1 km precision to 0.5)
require(tidyr)
NHM$error_radius <- NHM$error_radius %>% replace_na(0.5)
NHM <- subset(NHM, error_radius <= 10)
```


